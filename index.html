<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invitacion Baby shower</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            width: 100%;
            height: 100vh;
            height: 100dvh; /* Dynamic viewport height para Chrome iOS */
            overflow: hidden;
            background-color: #fff2ea;
            position: fixed;
            top: 0;
            left: 0;
        }
        
        img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }
        
        .img-desktop {
            display: block;
        }
        
        .img-mobile {
            display: none;
        }

        .button {
            position: absolute;
            bottom: 40px;
            left: 43%;
            width: 200px;
            height: 50px;
            background-color: #ffdada;
            color: #b15f4a;
            box-shadow: 0 20px 25px -5px #b15f4a;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }
        
        .button:hover {
            background-color: #b15f4a;
            color: #fff;
            border: none;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            height: 100dvh; /* Dynamic viewport height para Chrome iOS */
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background-color: #fff;
            padding: 30px;
            padding-bottom: calc(30px + env(safe-area-inset-bottom));
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            max-height: 90dvh; /* Dynamic viewport height para Chrome iOS */
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            margin: auto;
            display: flex;
            flex-direction: column;
        }
        
        .modal-content form {
            display: flex;
            flex-direction: column;
            min-height: 100%;
        }
        
        .modal-content form > *:not(button[type="submit"]):not(.mensaje-confirmacion) {
            flex-shrink: 0;
        }
        
        .modal-content form button[type="submit"] {
            margin-top: auto;
        }
        
        .modal h2 {
            color: #b15f4a;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .modal label {
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }
        
        .modal input,
        .modal select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        .modal input:focus,
        .modal select:focus {
            outline: none;
            border-color: #b15f4a;
        }
        
        .modal button[type="submit"] {
            width: 100%;
            padding: 12px;
            margin-top: 20px;
            margin-bottom: env(safe-area-inset-bottom);
            background-color: #b15f4a;
            color: #fff;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            flex-shrink: 0;
        }
        
        .modal button[type="submit"]:hover {
            background-color: #8d4a3a;
        }
        
        .close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 30px;
            height: 30px;
        }
        
        .close-modal:hover {
            color: #b15f4a;
        }
        
        .mensaje-confirmacion {
            display: none;
            text-align: center;
            padding: 30px 20px;
            background-color: #ffdada;
            color: #ffffff;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px solid #b15f4a;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 1001;
            opacity: 1 !important;
        }
        
        .mensaje-confirmacion.activo {
            display: block;
        }
        
        .mensaje-confirmacion h3 {
            margin: 0 0 10px 0;
            font-size: 24px;
            color: #b15f4a;
            font-weight: 700;
        }
        
        .mensaje-confirmacion p {
            margin: 0;
            font-size: 16px;
            color: #b15f4a;
        }
        
        .form-deshabilitado {
            pointer-events: none;
        }
        
        .form-deshabilitado input,
        .form-deshabilitado select,
        .form-deshabilitado button:not(.mensaje-confirmacion) {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .form-deshabilitado .mensaje-confirmacion {
            opacity: 1 !important;
            pointer-events: auto;
        }
        
        .regalo-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin-bottom: 8px;
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            border-left: 3px solid #b15f4a;
        }
        
        .regalo-item:last-child {
            margin-bottom: 0;
        }
        
        .regalo-nombre {
            flex: 1;
            color: #333;
            font-size: 14px;
        }
        
        .regalo-eliminar {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .regalo-eliminar:hover {
            background-color: #c82333;
        }
        
        @media (max-width: 800px) {
            .button {
                bottom: 18%;
                left: 40%;
                width: 150px;
                height: 30px;
                font-size: 14px;
            }
            
            .mensaje-confirmacion {
                padding: 25px 15px;
            }
            
            .mensaje-confirmacion h3 {
                font-size: 20px;
            }
            
            .mensaje-confirmacion p {
                font-size: 14px;
            }
        }

        /* Para pantallas m√≥viles (hasta 450px) */
        @media (max-width: 450px) {
            .img-desktop {
                display: none;
            }
            
            .img-mobile {
                display: block;
            }
            .button {
                bottom: 5%;
                bottom: calc(5% + env(safe-area-inset-bottom));
                left: 20%;
                width: 150px;
                height: 30px;
                font-size: 14px;
            }
            
            .modal-content {
                max-height: 85dvh;
                padding-bottom: calc(30px + env(safe-area-inset-bottom));
            }
            
            .modal button[type="submit"] {
                margin-bottom: calc(20px + env(safe-area-inset-bottom));
            }
            
            .mensaje-confirmacion {
                padding: 20px 15px;
                margin-top: 15px;
            }
            
            .mensaje-confirmacion h3 {
                font-size: 18px;
            }
            
            .mensaje-confirmacion p {
                font-size: 13px;
            }
        }
        
        /* Fix espec√≠fico para Chrome en iOS */
        @supports (-webkit-touch-callout: none) {
            .modal {
                height: -webkit-fill-available;
            }
            
            body {
                height: -webkit-fill-available;
            }
            
            @media (max-width: 450px) {
                .modal-content {
                    max-height: 85vh;
                    max-height: -webkit-fill-available;
                }
            }
        }
    </style>
    
</head>
<body>
    <img src="invitacion.png" alt="Invitacion" class="img-desktop">
    <img src="invitacion_mobile.png" alt="Invitacion" class="img-mobile">
    <button class="button">Presiona aqu√≠</button>
    <div class="modal" id="modal">
        <form class="modal-content" id="form">
            <button class="close-modal" id="closeModal">&times;</button>
            <h2>Confirmar asistencia</h2>
            <label for="nombre">Nombre completo</label>
            <input type="text" name="nombre" placeholder="Nombre completo" id="nombre" required>
            <label for="regalo">Selecciona tu regalo</label>
            <select id="regalo">
                <option value="">Selecciona un regalo</option>
            </select>
            <div id="regalosSeleccionadosContainer" style="margin-top: 15px; display: none;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #b15f4a;">Regalos seleccionados:</label>
                <div id="regalosSeleccionadosLista" style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #ddd; max-height: 150px; overflow-y: auto;"></div>
            </div>
            <button type="submit">Confirmar</button>
            <div class="mensaje-confirmacion" id="mensajeConfirmacion">
                <h3>¬°Confirmaci√≥n exitosa!</h3>
                <p>Tu asistencia y regalo han sido confirmados. Gracias por tu respuesta.</p>
            </div>
        </form>
    </div>

    <script>
        // ============================================
        // CONFIGURACI√ìN DE FIREBASE
        // ============================================
        // INSTRUCCIONES:
        // 1. Ve a https://console.firebase.google.com/
        // 2. Crea un nuevo proyecto (o usa uno existente)
        // 3. Ve a "Realtime Database" y crea una base de datos
        // 4. En "Configuraci√≥n del proyecto" > "Tus aplicaciones" > Web
        // 5. Copia la configuraci√≥n y p√©galo aqu√≠ abajo
        // 6. En "Reglas" de Realtime Database, cambia a:
        //    {
        //      "rules": {
        //        ".read": true,
        //        ".write": true
        //      }
        //    }
        
        const firebaseConfig = {
            apiKey: "AIzaSyDirxbiYoE4_BJllRnMVA6yl9g77xikAEI",
            authDomain: "baby-shower-regalos-6db55.firebaseapp.com",
            databaseURL: "https://baby-shower-regalos-6db55-default-rtdb.firebaseio.com",
            projectId: "baby-shower-regalos-6db55",
            storageBucket: "baby-shower-regalos-6db55.firebasestorage.app",
            messagingSenderId: "714310353905",
            appId: "1:714310353905:web:b9d0cca17950d4be9efa50"
          };
        
        // Inicializar Firebase (solo si est√° configurado)
        let database = null;
        let usarFirebase = false;
        
        // Verificar si Firebase est√° configurado (no es un placeholder)
        const firebaseConfigurado = firebaseConfig.apiKey && 
                                    firebaseConfig.apiKey !== "TU_API_KEY_AQUI" &&
                                    firebaseConfig.databaseURL &&
                                    firebaseConfig.databaseURL !== "https://TU_PROJECT_ID-default-rtdb.firebaseio.com";
        
        if (firebaseConfigurado) {
            try {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                usarFirebase = true;
                console.log('‚úÖ Firebase inicializado correctamente');
                console.log('üì° Sincronizaci√≥n en tiempo real activada');
            } catch (error) {
                console.error('‚ùå Error al inicializar Firebase:', error);
                console.log('‚ö†Ô∏è Usando localStorage como respaldo');
            }
        } else {
            console.log('‚ö†Ô∏è Firebase no configurado, usando localStorage');
            console.log('üí° Los datos solo se guardar√°n localmente en este dispositivo');
        }
        
        const button = document.querySelector('.button');
        const modal = document.getElementById('modal');
        const closeModal = document.getElementById('closeModal');
        
        // Regalos directamente en el c√≥digo
        const regalos = [
            { "id": 1, "nombre": "Body de manga corta (0-3 meses)" },
            { "id": 2, "nombre": "Body de manga corta (3-6 meses)" },
            { "id": 3, "nombre": "Body de manga larga (0-3 meses)" },
            { "id": 4, "nombre": "Body de manga larga (3-6 meses)" },
            { "id": 5, "nombre": "Pijama enterizo (0-3 meses)" },
            { "id": 6, "nombre": "Pijama enterizo (3-6 meses)" },
            { "id": 11, "nombre": "Su√©ter ligero (6-9 meses)" },
            { "id": 12, "nombre": "Su√©ter ligero (9-12 meses)" },
            { "id": 13, "nombre": "Gorrito para reci√©n nacido" },
            { "id": 14, "nombre": "Patucos o medias para beb√©" },
            { "id": 15, "nombre": "Guantes antifricci√≥n (reci√©n nacido)" },
            { "id": 16, "nombre": "Manta ligera para beb√©" },
            { "id": 19, "nombre": "Paquete de 2-3 bodys neutros (0-6 meses)" },
            { "id": 20, "nombre": "Paquete de 2 pijamas neutros (6-12 meses)" },
            { "id": 21, "nombre": "Colchoneta antifluidos" },
            { "id": 22, "nombre": "Set de aseo beb√© (cepillo, peine, corta√∫√±as)" },
            { "id": 23, "nombre": "Champ√∫ y gel de ba√±o sin fragancia" },
            { "id": 24, "nombre": "Toalla con capucha beb√©" },
            { "id": 25, "nombre": "Pa√±os suaves para ba√±o (washcloths)" },
            { "id": 26, "nombre": "Crema para el cambio de pa√±al" },
            { "id": 27, "nombre": "Cojin de lactancia" },  
            { "id": 28, "nombre": "Mini kit de primeros auxilios para beb√©" },
            { "id": 29, "nombre": "Kit de manicura beb√© (u√±a y lima)" },
            { "id": 30, "nombre": "Crema hidratante para beb√©" },
            { "id": 31, "nombre": "Term√≥metro para beb√©" },
            { "id": 32, "nombre": "Aspirador nasal beb√©" },
            { "id": 33, "nombre": "Biber√≥n o botella de vidrio/acero" },
            { "id": 34, "nombre": "Babero de silicona" },
            { "id": 35, "nombre": "Ropa interior + pijama para mam√° (postparto)" },
            { "id": 36, "nombre": "Kit de aseo para mam√° (cremas, toallas, etc.)" },
            { "id": 37, "nombre": "Bata o kimono ligero para mam√°" },
            { "id": 38, "nombre": "Sujetadores de lactancia para mam√°" },
            { "id": 39, "nombre": "Vaso o botella reutilizable para mam√°" },
            { "id": 40, "nombre": "Bolso de cambio beb√© + mam√°" },
            { "id": 41, "nombre": "Pijama mam√° + beb√© (juego combinado)" },
            { "id": 42, "nombre": "Bodies con estampados neutros (0-6 meses)" },
            { "id": 43, "nombre": "Aceite corporal para mam√° (postparto)" },
            { "id": 44, "nombre": "Toallitas √≠ntimas para mam√°" },
            { "id": 45, "nombre": "Juguete de estimulacion temprana" },
            { "id": 46, "nombre": "Organizador de ropa beb√©" },
            { "id": 47, "nombre": "Bolsa para ropa sucia del beb√©" },
            { "id": 48, "nombre": "Set de babitas o pa√±alitos de tela absorbentes" },
            { "id": 49, "nombre": "Bodies para ocasi√≥n especial (0-3 meses)" },
            { "id": 50, "nombre": "Bodies para ocasi√≥n especial (3-6 meses)" },
            { "id": 51, "nombre": "Pijamas para ocasi√≥n especial (6-12 meses)" },
            { "id": 52, "nombre": "Manta o chal especial para fotos" },
            { "id": 53, "nombre": "Libro de hitos del beb√©" },
            { "id": 54, "nombre": "√Ålbum de fotos del beb√©" },
            { "id": 55, "nombre": "Gorro + bufanda beb√© (meses fr√≠os)" },
            { "id": 56, "nombre": "Pantalones suaves o leggings beb√© (6-12 meses)" },
            { "id": 57, "nombre": "Camisetas neutras beb√© (pack)" },
            { "id": 58, "nombre": "Calcetines suaves beb√© (pack)" },
            { "id": 59, "nombre": "Baberos de tela lavable (pack)" },
            { "id": 60, "nombre": "Cobija o swaddle ligera (muselina)" },
            { "id": 61, "nombre": "Pijamas de algod√≥n org√°nico beb√©" },
            { "id": 62, "nombre": "Monitor o vigilabeb√©s b√°sico" },
            { "id": 63, "nombre": "Luz de noche para cuarto del beb√©" },
            { "id": 64, "nombre": "Neceser o bolsa de pa√±ales mam√°-beb√©" },
            { "id": 65, "nombre": "Toallitas de aseo para mam√° (mini kit)" },
            { "id": 66, "nombre": "Set de cuidado bucal beb√© (cepillo, pasta suave)" },
            { "id": 67, "nombre": "Gorros de algod√≥n (varios colores)" },
            { "id": 68, "nombre": "Bodies con estampados neutros (9-12 meses)" },
            { "id": 69, "nombre": "Ropa exterior ligera beb√© (6-9 meses)" },
            { "id": 70, "nombre": "Pijama tipo saco de dormir (6-12 meses)" },
            { "id": 71, "nombre": "Detergente suave + bolsas para ropa beb√©" },
            { "id": 72, "nombre": "Pa√±ales ecol√≥gicos o de tela (alternativa)" },
            { "id": 73, "nombre": "Set de masaje para beb√© (aceite + gu√≠a)" },
            { "id": 74, "nombre": "Tarjeta de regalo para tienda de beb√© o mam√°" },
            { "id": 75, "nombre": "Portachupete o cadena para chupete" },
            { "id": 76, "nombre": "Set de cucharas y platos de silicona (inicio alimentaci√≥n)" },
            { "id": 77, "nombre": "Mordedera de silicona o tela suave" },
            { "id": 78, "nombre": "Libro sensorial o de tela para beb√©" }
        ];
        
        let regalos_seleccionados = [];
        
        // Funciones para manejar IDs de regalos confirmados (solo para filtrado)
        // Usa Firebase si est√° disponible, sino localStorage
        let idsRegalosConfirmadosCache = [];
        
        function obtenerIdsRegalosConfirmados() {
            return idsRegalosConfirmadosCache;
        }
        
        async function cargarIdsRegalosConfirmados() {
            if (usarFirebase && database) {
                try {
                    const snapshot = await database.ref('regalos_confirmados').once('value');
                    const ids = snapshot.val();
                    idsRegalosConfirmadosCache = ids ? ids.map(id => Number(id)) : [];
                    console.log('‚úÖ IDs de regalos confirmados cargados desde Firebase:', idsRegalosConfirmadosCache);
                    console.log('üì° Datos sincronizados desde la nube');
                    return idsRegalosConfirmadosCache;
                } catch (error) {
                    console.error('‚ùå Error al cargar desde Firebase:', error);
                    console.log('üíæ Intentando cargar desde localStorage...');
                    // Fallback a localStorage
                    return cargarDesdeLocalStorage();
                }
            } else {
                console.log('üíæ Cargando desde localStorage (Firebase no configurado)');
                return cargarDesdeLocalStorage();
            }
        }
        
        function cargarDesdeLocalStorage() {
            try {
                const confirmados = localStorage.getItem('regalos_confirmados');
                if (!confirmados) {
                    idsRegalosConfirmadosCache = [];
                    return [];
                }
                const ids = JSON.parse(confirmados);
                idsRegalosConfirmadosCache = ids.map(id => Number(id));
                return idsRegalosConfirmadosCache;
            } catch (error) {
                console.error('Error al obtener IDs de regalos confirmados:', error);
                idsRegalosConfirmadosCache = [];
                return [];
            }
        }
        
        async function guardarIdsRegalosConfirmados(idsRegalos) {
            try {
                const idsNumericos = idsRegalos.map(id => Number(id));
                const nuevosConfirmados = [...new Set([...idsRegalosConfirmadosCache, ...idsNumericos])];
                idsRegalosConfirmadosCache = nuevosConfirmados;
                
                if (usarFirebase && database) {
                    await database.ref('regalos_confirmados').set(nuevosConfirmados);
                    console.log('‚úÖ IDs de regalos confirmados guardados en Firebase:', nuevosConfirmados);
                    console.log('üì° Sincronizaci√≥n: Los cambios se ver√°n en todos los dispositivos');
                } else {
                    localStorage.setItem('regalos_confirmados', JSON.stringify(nuevosConfirmados));
                    console.log('üíæ IDs de regalos confirmados guardados en localStorage:', nuevosConfirmados);
                    console.log('‚ö†Ô∏è Solo visible en este dispositivo (Firebase no configurado)');
                }
            } catch (error) {
                console.error('‚ùå Error al guardar IDs de regalos confirmados:', error);
                // Fallback a localStorage si Firebase falla
                try {
                    localStorage.setItem('regalos_confirmados', JSON.stringify(idsRegalosConfirmadosCache));
                    console.log('üíæ Guardado en localStorage como respaldo');
                } catch (localError) {
                    console.error('‚ùå Error al guardar en localStorage:', localError);
                }
            }
        }
        
        // Funciones para manejar confirmaciones con nombres (regalo y persona)
        // Estructura: [{nombreRegalo: "Body de manga corta", nombrePersona: "Juan P√©rez"}, ...]
        let confirmacionesCache = [];
        
        function obtenerConfirmaciones() {
            return confirmacionesCache;
        }
        
        async function cargarConfirmaciones() {
            if (usarFirebase && database) {
                try {
                    const snapshot = await database.ref('confirmaciones').once('value');
                    const confirmaciones = snapshot.val();
                    confirmacionesCache = confirmaciones || [];
                    console.log('‚úÖ Confirmaciones cargadas desde Firebase:', confirmacionesCache);
                    console.log('üì° Datos sincronizados desde la nube');
                    return confirmacionesCache;
                } catch (error) {
                    console.error('‚ùå Error al cargar confirmaciones desde Firebase:', error);
                    console.log('üíæ Intentando cargar desde localStorage...');
                    return cargarConfirmacionesDesdeLocalStorage();
                }
            } else {
                console.log('üíæ Cargando desde localStorage (Firebase no configurado)');
                return cargarConfirmacionesDesdeLocalStorage();
            }
        }
        
        function cargarConfirmacionesDesdeLocalStorage() {
            try {
                const confirmaciones = localStorage.getItem('confirmaciones');
                confirmacionesCache = confirmaciones ? JSON.parse(confirmaciones) : [];
                return confirmacionesCache;
            } catch (error) {
                console.error('Error al obtener confirmaciones:', error);
                confirmacionesCache = [];
                return [];
            }
        }
        
        async function guardarConfirmaciones(nuevasConfirmaciones) {
            try {
                confirmacionesCache = [...confirmacionesCache, ...nuevasConfirmaciones];
                
                if (usarFirebase && database) {
                    await database.ref('confirmaciones').set(confirmacionesCache);
                    console.log('‚úÖ Confirmaciones guardadas en Firebase:', confirmacionesCache);
                    console.log('üì° Sincronizaci√≥n: Los cambios se ver√°n en todos los dispositivos');
                } else {
                    localStorage.setItem('confirmaciones', JSON.stringify(confirmacionesCache));
                    console.log('üíæ Confirmaciones guardadas en localStorage:', confirmacionesCache);
                    console.log('‚ö†Ô∏è Solo visible en este dispositivo (Firebase no configurado)');
                }
            } catch (error) {
                console.error('‚ùå Error al guardar confirmaciones:', error);
                // Fallback a localStorage si Firebase falla
                try {
                    localStorage.setItem('confirmaciones', JSON.stringify(confirmacionesCache));
                    console.log('üíæ Guardado en localStorage como respaldo');
                } catch (localError) {
                    console.error('‚ùå Error al guardar en localStorage:', localError);
                }
            }
        }
        
        // Escuchar cambios en Firebase en tiempo real
        function configurarEscuchaFirebase() {
            if (usarFirebase && database) {
                // Escuchar cambios en regalos confirmados
                database.ref('regalos_confirmados').on('value', (snapshot) => {
                    const ids = snapshot.val();
                    idsRegalosConfirmadosCache = ids ? ids.map(id => Number(id)) : [];
                    console.log('IDs actualizados desde Firebase:', idsRegalosConfirmadosCache);
                    // Actualizar el select cuando cambien los datos
                    llenarSelectRegalos();
                });
                
                // Escuchar cambios en confirmaciones
                database.ref('confirmaciones').on('value', (snapshot) => {
                    const confirmaciones = snapshot.val();
                    confirmacionesCache = confirmaciones || [];
                    console.log('Confirmaciones actualizadas desde Firebase:', confirmacionesCache);
                });
            }
        }
        
        // ============================================
        // FUNCIONES DE ADMINISTRACI√ìN
        // ============================================
        // Estas funciones se pueden ejecutar desde la consola del navegador (F12)
        
        // Eliminar un regalo espec√≠fico por ID (para que vuelva a estar disponible)
        async function eliminarRegaloConfirmado(idRegalo) {
            const id = Number(idRegalo);
            if (!id || isNaN(id)) {
                console.error('ID inv√°lido. Usa: eliminarRegaloConfirmado(5)');
                return;
            }
            
            // Eliminar de la lista de IDs confirmados
            const nuevosIds = idsRegalosConfirmadosCache.filter(regaloId => regaloId !== id);
            idsRegalosConfirmadosCache = nuevosIds;
            
            if (usarFirebase && database) {
                try {
                    await database.ref('regalos_confirmados').set(nuevosIds);
                    console.log('Regalo eliminado de Firebase. ID:', id);
                } catch (error) {
                    console.error('Error al eliminar de Firebase:', error);
                }
            } else {
                localStorage.setItem('regalos_confirmados', JSON.stringify(nuevosIds));
                console.log('Regalo eliminado de localStorage. ID:', id);
            }
            
            // Eliminar las confirmaciones relacionadas con este regalo
            const regalo = regalos.find(r => r.id === id);
            if (regalo) {
                const nuevasConfirmaciones = confirmacionesCache.filter(conf => 
                    conf.nombreRegalo !== regalo.nombre
                );
                confirmacionesCache = nuevasConfirmaciones;
                
                if (usarFirebase && database) {
                    try {
                        await database.ref('confirmaciones').set(nuevasConfirmaciones);
                    } catch (error) {
                        console.error('Error al actualizar confirmaciones:', error);
                    }
                } else {
                    localStorage.setItem('confirmaciones', JSON.stringify(nuevasConfirmaciones));
                }
            }
            
            // Actualizar el select
            llenarSelectRegalos();
            console.log('‚úÖ Regalo ID', id, 'eliminado. Ahora est√° disponible nuevamente.');
        }
        
        // Ver todas las confirmaciones
        function verConfirmaciones() {
            console.log('=== CONFIRMACIONES ===');
            console.table(confirmacionesCache);
            console.log('Total:', confirmacionesCache.length);
            return confirmacionesCache;
        }
        
        // Ver IDs de regalos confirmados
        function verRegalosConfirmados() {
            console.log('=== REGALOS CONFIRMADOS (IDs) ===');
            console.log(idsRegalosConfirmadosCache);
            console.log('Total:', idsRegalosConfirmadosCache.length);
            
            // Mostrar tambi√©n los nombres de los regalos
            const regalosConfirmadosConNombre = idsRegalosConfirmadosCache.map(id => {
                const regalo = regalos.find(r => r.id === id);
                return { id: id, nombre: regalo ? regalo.nombre : 'No encontrado' };
            });
            console.table(regalosConfirmadosConNombre);
            return idsRegalosConfirmadosCache;
        }
        
        // Resetear todo (eliminar todas las confirmaciones)
        async function resetearTodo() {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar TODAS las confirmaciones? Esto no se puede deshacer.')) {
                return;
            }
            
            idsRegalosConfirmadosCache = [];
            confirmacionesCache = [];
            
            if (usarFirebase && database) {
                try {
                    await database.ref('regalos_confirmados').set([]);
                    await database.ref('confirmaciones').set([]);
                    console.log('‚úÖ Todo reseteado en Firebase');
                } catch (error) {
                    console.error('Error al resetear en Firebase:', error);
                }
            } else {
                localStorage.removeItem('regalos_confirmados');
                localStorage.removeItem('confirmaciones');
                console.log('‚úÖ Todo reseteado en localStorage');
            }
            
            // Actualizar el select
            llenarSelectRegalos();
            console.log('‚úÖ Todos los regalos est√°n disponibles nuevamente');
        }
        
        // Eliminar confirmaci√≥n por nombre de persona
        async function eliminarConfirmacionesPorPersona(nombrePersona) {
            if (!nombrePersona) {
                console.error('Debes proporcionar un nombre. Usa: eliminarConfirmacionesPorPersona("Juan P√©rez")');
                return;
            }
            
            // Encontrar los regalos confirmados por esta persona
            const confirmacionesPersona = confirmacionesCache.filter(conf => 
                conf.nombrePersona.toLowerCase() === nombrePersona.toLowerCase()
            );
            
            if (confirmacionesPersona.length === 0) {
                console.log('No se encontraron confirmaciones para:', nombrePersona);
                return;
            }
            
            console.log('Confirmaciones encontradas:', confirmacionesPersona);
            
            // Obtener los IDs de los regalos a eliminar
            const idsAEliminar = confirmacionesPersona.map(conf => {
                const regalo = regalos.find(r => r.nombre === conf.nombreRegalo);
                return regalo ? regalo.id : null;
            }).filter(id => id !== null);
            
            // Eliminar cada regalo
            for (const id of idsAEliminar) {
                await eliminarRegaloConfirmado(id);
            }
            
            console.log('‚úÖ Confirmaciones de', nombrePersona, 'eliminadas');
        }
        
        // Hacer funciones disponibles globalmente para uso desde consola
        window.eliminarRegaloConfirmado = eliminarRegaloConfirmado;
        window.verConfirmaciones = verConfirmaciones;
        window.verRegalosConfirmados = verRegalosConfirmados;
        window.resetearTodo = resetearTodo;
        window.eliminarConfirmacionesPorPersona = eliminarConfirmacionesPorPersona;
        
        console.log('üîß Funciones de administraci√≥n disponibles:');
        console.log('  - eliminarRegaloConfirmado(id) - Elimina un regalo por ID');
        console.log('  - verConfirmaciones() - Muestra todas las confirmaciones');
        console.log('  - verRegalosConfirmados() - Muestra los IDs confirmados');
        console.log('  - resetearTodo() - Elimina todas las confirmaciones');
        console.log('  - eliminarConfirmacionesPorPersona("nombre") - Elimina confirmaciones de una persona');
        
        // Funci√≥n para obtener regalos disponibles (excluyendo los confirmados)
        function obtenerRegalosDisponibles() {
            const idsConfirmados = obtenerIdsRegalosConfirmados();
            return regalos.filter(regalo => !idsConfirmados.includes(Number(regalo.id)));
        }
        
        // Llenar el select con las opciones de regalos disponibles (excluyendo los ya seleccionados y confirmados)
        function llenarSelectRegalos() {
            const selectRegalo = document.getElementById('regalo');
            if (!selectRegalo) {
                console.error('No se encontr√≥ el elemento select con id "regalo"');
                return;
            }
            
            // Asegurar que el select est√© habilitado
            selectRegalo.disabled = false;
            
            // Obtener regalos disponibles (ya filtrados por confirmados desde localStorage)
            const regalosDisponiblesBase = obtenerRegalosDisponibles();
            
            // Obtener IDs de regalos ya seleccionados en esta sesi√≥n
            const idsSeleccionados = regalos_seleccionados.map(r => Number(r.id));
            
            // Filtrar tambi√©n los seleccionados en esta sesi√≥n
            const regalosDisponibles = regalosDisponiblesBase.filter(regalo => 
                !idsSeleccionados.includes(Number(regalo.id))
            );
            
            const idsConfirmados = obtenerIdsRegalosConfirmados();
            console.log('IDs seleccionados en sesi√≥n:', idsSeleccionados);
            console.log('IDs confirmados (localStorage):', idsConfirmados);
            console.log('Regalos disponibles (sin confirmados):', regalosDisponiblesBase.length);
            console.log('Regalos para mostrar (sin seleccionados en sesi√≥n):', regalosDisponibles.length);
            
            // Limpiar opciones existentes
            selectRegalo.innerHTML = '<option value="">Selecciona un regalo</option>';
            
            if (regalosDisponibles.length === 0) {
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "No hay m√°s regalos disponibles";
                option.disabled = true;
                selectRegalo.appendChild(option);
                console.log('No hay m√°s regalos disponibles');
                return;
            }
            
            regalosDisponibles.forEach((regalo) => {
                const option = document.createElement('option');
                option.value = regalo.id;
                option.textContent = regalo.nombre;
                selectRegalo.appendChild(option);
            });
            
            console.log('Select llenado con', regalosDisponibles.length, 'regalos disponibles');
        }
        
        // Funci√≥n para mostrar los regalos seleccionados
        function mostrarRegalosSeleccionados() {
            const container = document.getElementById('regalosSeleccionadosContainer');
            const lista = document.getElementById('regalosSeleccionadosLista');
            
            if (!container || !lista) return;
            
            if (regalos_seleccionados.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            lista.innerHTML = '';
            
            regalos_seleccionados.forEach((regalo, index) => {
                const item = document.createElement('div');
                item.className = 'regalo-item';
                
                const nombre = document.createElement('span');
                nombre.className = 'regalo-nombre';
                nombre.textContent = `${index + 1}. ${regalo.nombre}`;
                
                const eliminar = document.createElement('button');
                eliminar.className = 'regalo-eliminar';
                eliminar.textContent = 'Eliminar';
                eliminar.type = 'button';
                eliminar.addEventListener('click', function() {
                    // Eliminar el regalo de la lista
                    regalos_seleccionados.splice(index, 1);
                    // Actualizar la visualizaci√≥n
                    mostrarRegalosSeleccionados();
                    // Actualizar el select para mostrar el regalo eliminado
                    llenarSelectRegalos();
                });
                
                item.appendChild(nombre);
                item.appendChild(eliminar);
                lista.appendChild(item);
            });
        }
        
        // Variable para evitar agregar m√∫ltiples event listeners
        let seleccionRegaloConfigurado = false;
        
        // Manejar la selecci√≥n de un regalo
        function manejarSeleccionRegalo() {
            const selectRegalo = document.getElementById('regalo');
            if (!selectRegalo) return;
            
            // Evitar agregar m√∫ltiples event listeners
            if (seleccionRegaloConfigurado) return;
            seleccionRegaloConfigurado = true;
            
            selectRegalo.addEventListener('change', function() {
                const regaloId = parseInt(this.value);
                
                if (regaloId && regaloId > 0) {
                    // Buscar el regalo seleccionado
                    const regaloSeleccionado = regalos.find(r => r.id === regaloId);
                    
                    if (regaloSeleccionado) {
                        // Agregar a regalos_seleccionados si no est√° ya
                        const yaExiste = regalos_seleccionados.some(r => r.id === regaloId);
                        
                        if (!yaExiste) {
                            regalos_seleccionados.push(regaloSeleccionado);
                            console.log('Regalo agregado:', regaloSeleccionado.nombre);
                            console.log('Regalos seleccionados:', regalos_seleccionados.length);
                            
                            // Actualizar la visualizaci√≥n de regalos seleccionados
                            mostrarRegalosSeleccionados();
                            
                            // Actualizar el select para ocultar el regalo seleccionado
                            llenarSelectRegalos();
                            
                            // Resetear el select a la opci√≥n por defecto
                            selectRegalo.value = "";
                        }
                    }
                }
            });
        }
        
        // Event listener para abrir el modal
        button.addEventListener('click', async function() {
            modal.classList.add('active');
            
            // Fix para Chrome iOS: forzar rec√°lculo del viewport
            setTimeout(() => {
                const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
                modal.style.height = viewportHeight + 'px';
                // Forzar reflow
                void modal.offsetHeight;
            }, 100);
            
            // Recargar datos desde Firebase/localStorage cuando se abre el modal
            await cargarIdsRegalosConfirmados();
            // Asegurar que el select est√© habilitado
            const selectRegalo = document.getElementById('regalo');
            if (selectRegalo) {
                selectRegalo.disabled = false;
                // Actualizar el select cuando se abre el modal
                llenarSelectRegalos();
                // Mostrar regalos seleccionados si hay alguno
                mostrarRegalosSeleccionados();
            }
        });
        
        closeModal.addEventListener('click', function() {
            modal.classList.remove('active');
        });
        
        // Cerrar modal al hacer clic fuera del contenido
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.classList.remove('active');
            }
        });
        
        // Manejar el env√≠o del formulario
        const form = document.getElementById('form');
        const mensajeConfirmacion = document.getElementById('mensajeConfirmacion');
        const inputNombre = document.getElementById('nombre');
        
        form.addEventListener('submit', async function(e) {
            e.preventDefault(); // Prevenir env√≠o por defecto
            
            const nombre = inputNombre.value.trim();
            
            // Validar que haya nombre
            if (!nombre) {
                alert('Por favor, ingresa tu nombre completo');
                return;
            }
            
            // Validar que haya al menos un regalo seleccionado
            if (regalos_seleccionados.length === 0) {
                alert('Por favor, selecciona al menos un regalo');
                return;
            }
            
            // Preparar datos (solo para mostrar en consola)
            const datos = {
                nombre: nombre,
                regalos: regalos_seleccionados.map(r => r.nombre).join(', '),
                fecha: new Date().toLocaleString('es-ES')
            };
            
            // Guardar los IDs de regalos confirmados (para filtrado)
            const idsRegalosConfirmados = regalos_seleccionados.map(r => r.id);
            await guardarIdsRegalosConfirmados(idsRegalosConfirmados);
            
            // Guardar las confirmaciones con nombres (regalo y persona)
            const confirmaciones = regalos_seleccionados.map(r => ({
                nombreRegalo: r.nombre,
                nombrePersona: nombre
            }));
            await guardarConfirmaciones(confirmaciones);
            
            // Mostrar mensaje de confirmaci√≥n
            mensajeConfirmacion.classList.add('activo');
            
            // Deshabilitar el formulario
            form.classList.add('form-deshabilitado');
            inputNombre.disabled = true;
            document.getElementById('regalo').disabled = true;
            form.querySelector('button[type="submit"]').disabled = true;
            
            // Deshabilitar el bot√≥n de cerrar
            closeModal.style.display = 'none';
            
            // Ocultar el bot√≥n "Presiona aqu√≠" si existe
            button.style.display = 'none';
            
            console.log('Confirmaci√≥n registrada:', datos);
            console.log('IDs de regalos confirmados (para filtrado):', idsRegalosConfirmados);
            console.log('Confirmaciones guardadas (con nombres):', confirmaciones);
        });
        
        // Funci√≥n para ajustar el viewport en Chrome iOS
        function ajustarViewport() {
            if (modal.classList.contains('active')) {
                const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
                modal.style.height = viewportHeight + 'px';
            }
        }
        
        // Listener para ajustar viewport cuando cambia el tama√±o (√∫til cuando aparece/desaparece el teclado)
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(ajustarViewport, 100);
        });
        
        // Tambi√©n ajustar cuando se hace scroll (Chrome iOS puede cambiar el viewport al hacer scroll)
        window.addEventListener('scroll', function() {
            if (modal.classList.contains('active')) {
                ajustarViewport();
            }
        }, { passive: true });
        
        // Inicializar cuando se carga la p√°gina
        async function inicializar() {
            console.log('Inicializando formulario...');
            
            // Cargar datos desde Firebase o localStorage
            await cargarIdsRegalosConfirmados();
            await cargarConfirmaciones();
            
            // Configurar escucha en tiempo real si se usa Firebase
            configurarEscuchaFirebase();
            
            const idsConfirmados = obtenerIdsRegalosConfirmados();
            const confirmaciones = obtenerConfirmaciones();
            const regalosDisponibles = obtenerRegalosDisponibles();
            
            console.log('Regalos totales:', regalos.length);
            console.log('IDs de regalos confirmados (para filtrado):', idsConfirmados.length, idsConfirmados);
            console.log('Confirmaciones guardadas (con nombres):', confirmaciones.length, confirmaciones);
            console.log('Regalos disponibles:', regalosDisponibles.length);
            console.log('Usando Firebase:', usarFirebase ? 'S√≠' : 'No (localStorage)');
            
            llenarSelectRegalos();
            manejarSeleccionRegalo();
            console.log('Formulario inicializado');
        }
        
        // Esperar a que el DOM est√© completamente cargado
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', inicializar);
        } else {
            // DOM ya est√° listo
            inicializar();
        }

    
    </script>
</body>
</html>